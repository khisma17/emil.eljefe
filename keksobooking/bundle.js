(()=>{"use strict";window.debounce=function(e){let t=null;return()=>{t&&window.clearTimeout(t),t=window.setTimeout(e,500)}},window.filter={getFilterHandlers:e=>{const t=Array.from(e.featuresInputs);return n=>{const r=[];for(let i=0;i<n.length;i+=1){const s=n[i],a=e=>{switch(e.value){case"any":return!0;case"low":return s.offer.price<=1e4;case"middle":return s.offer.price>1e4&&s.offer.price<=5e4;case"high":return s.offer.price>=5e4;default:return!1}},u=e=>"any"===e.value||s.offer.rooms===Number(e.value),c=e=>"any"===e.value||s.offer.guests===Number(e.value),d=e=>e.every((e=>!e.checked||e.checked&&s.offer.features.includes(e.value)));if(("any"===(o=e.housingTypeFilter).value||s.offer.type===o.value)&&a(e.priceFilter)&&u(e.roomsNumberFilter)&&c(e.guestsNumberFilter)&&d(t)&&r.push(s),5===r.length)break}var o;return r}}},(()=>{const e=(e,t)=>{const n=new XMLHttpRequest;return n.responseType="json",n.timeout=1e4,n.addEventListener("load",(()=>{200===n.status?e(n.response):t(`Статус ответа: ${n.status} ${n.statusText}`)})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{t(`Запрос не успел выполниться за ${n.timeout} мс`)})),n};window.backend={loadData:(t,n)=>{const r=e(t,n);r.open("GET","https://21.javascript.pages.academy/keksobooking/data"),r.send()},uploadForm:(t,n,r)=>{const o=e(n,r);o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(t)}}})(),(()=>{const e=["gif","jpg","jpeg","png"];window.imagePreview={getImagePreview:(t,n)=>{t.addEventListener("change",(()=>{const r=t.files[0],o=r.name.toLowerCase();if(e.some((e=>o.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{n.src=e.result})),e.readAsDataURL(r)}}))}}})(),(()=>{const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},t={rooms:{singular:"комната",nominative:"комнаты",genitive:"комнат"},guests:{singular:"гостя",plural:"гостей"}},n=(e,t)=>{const n=document.createElement("img");return n.src=e.offer.photos[t],n.classList.add("popup__photo"),n.width=45,n.height=40,n.alt="Фотография жилья",n};window.card={createCard:(r,o)=>{const i=r.cloneNode(!0),s=i.querySelector(".popup__title"),a=i.querySelector(".popup__text--address"),u=i.querySelector(".popup__text--price"),c=i.querySelector(".popup__type"),d=i.querySelector(".popup__text--capacity"),l=i.querySelector(".popup__text--time"),p=i.querySelector(".popup__features"),m=i.querySelector(".popup__description"),f=i.querySelector(".popup__photos"),v=i.querySelector(".popup__avatar"),g=o.offer.type;s.textContent=o.offer.title,a.textContent=o.offer.address,u.textContent=o.offer.price+"₽/ночь",c.textContent=e[g];const y=((e,t)=>{const n=Math.abs(e)%100,r=e%10;return n>10&&n<20?t.rooms.genitive:r>1&&r<5?t.rooms.nominative:1===r?t.rooms.singular:t.rooms.genitive})(o.offer.rooms,t),h=(w=o.offer.guests,S=t,1==Math.abs(w)%10?S.guests.singular:S.guests.plural);var w,S;d.textContent=`${o.offer.rooms} ${y} для ${o.offer.guests} ${h}`,l.textContent=`Заезд после ${o.offer.checkin}, выезд до ${o.offer.checkout}`,p.innerHTML="",o.offer.features.forEach(((e,t)=>{const n=((e,t)=>{const n=document.createElement("li");return n.classList.add("popup__feature"),n.classList.add("popup__feature--"+e.offer.features[t]),n})(o,t);p.appendChild(n)})),m.textContent=o.offer.description,f.innerHTML="";for(let e=0;e<o.offer.photos.length;e+=1){const t=n(o,e);f.appendChild(t)}return v.setAttribute("src",String(o.author.avatar)),i}}})(),window.form={getValidityCheckHandlers:e=>{const t="Выбранное количество гостей не подходит под количество комнат";return{validateGuestsNumber:()=>{"1"===e.roomsInput.value&&"1"!==e.guestsInput.value?(e.guestsInput.setCustomValidity(t),e.guestsInput.reportValidity()):"2"!==e.roomsInput.value||"3"!==e.guestsInput.value&&"0"!==e.guestsInput.value?"3"===e.roomsInput.value&&"0"===e.guestsInput.value||"100"===e.roomsInput.value&&"0"!==e.guestsInput.value?(e.guestsInput.setCustomValidity(t),e.guestsInput.reportValidity()):(e.guestsInput.setCustomValidity(""),e.guestsInput.reportValidity()):(e.guestsInput.setCustomValidity(t),e.guestsInput.reportValidity())},setTitleConstraints:()=>{e.titleInput.required=!0,e.titleInput.setAttribute("minlength",String(30)),e.titleInput.setAttribute("maxlength",String(100))},setHousingTypeConstraints:()=>{switch(e.housingTypeInput.value){case"bungalow":e.priceInput.setAttribute("min",String(0)),e.priceInput.setAttribute("placeholder",String(0));break;case"flat":e.priceInput.setAttribute("min",String(1e3)),e.priceInput.setAttribute("placeholder",String(1e3));break;case"house":e.priceInput.setAttribute("min",String(5e3)),e.priceInput.setAttribute("placeholder",String(5e3));break;case"palace":e.priceInput.setAttribute("min",String(1e4)),e.priceInput.setAttribute("placeholder",String(1e4))}},setPriceConstraints:()=>{e.priceInput.required=!0,e.priceInput.setAttribute("max",String(1e6))},setCheckInConstraints:()=>{e.checkOutInput.value=e.checkInInput.value},setCheckOutConstraints:()=>{e.checkInInput.value=e.checkOutInput.value},setImageConstraints:e=>{e.setAttribute("accept","image/*")}}}},window.activation={getPageActivationHandlers:(e,t,n,r)=>{const o=e.mainPin.offsetWidth,i=e.mainPin.offsetHeight,s=i+22,a=e.mainPin.offsetLeft+o/2,u=e.mainPin.offsetTop+i/2,c=e.mainPin.offsetTop+s,d=e.mainPin.offsetLeft,l=e.mainPin.offsetTop,p=(t,n)=>{e.addressInput.setAttribute("value",`${Math.round(t)}, ${Math.round(n)}`)},m=()=>{e.map.classList.remove("map--faded"),e.form.classList.remove("ad-form--disabled"),e.formFieldsets.forEach((e=>{e.removeAttribute("disabled")})),p(a,c),window.backend.loadData(n,r),e.mainPin.removeEventListener("mousedown",f),e.mainPin.removeEventListener("keydown",v)},f=e=>{0===e.button&&m()},v=e=>{"Enter"===e.key&&m()};return{setInactivePageMode:()=>{e.map.classList.contains("map--faded")||e.map.classList.add("map--faded"),e.form.classList.add("ad-form--disabled"),t.clearPins(),t.clearCards(),e.formFieldsets.forEach((e=>{e.setAttribute("disabled","")})),e.filtersFieldsets.forEach((e=>{e.setAttribute("disabled","")})),e.mainPin.style.left=d+"px",e.mainPin.style.top=l+"px",p(a,u),e.mainPin.addEventListener("mousedown",f),e.mainPin.addEventListener("keydown",v)},pinWidth:o,pinHeight:i,pinHeightActive:s}},activateFilters:e=>{e.filtersFieldsets.forEach((e=>{e.removeAttribute("disabled")}))}},window.pin={createPin:(e,t)=>{const n=e.cloneNode(!0),r=n.querySelector("img");return n.setAttribute("style",`left: ${t.location.x+window.main.pageActivation.pinWidth/2}px; top: ${t.location.y+window.main.pageActivation.pinHeight}px;`),r.setAttribute("src",String(t.author.avatar)),r.setAttribute("alt",String(t.offer.title)),n}},window.map={getRenderingHandlers:(e,t)=>{const n=t=>{const n=window.card.createCard(e.cardTemplate,t),r=n.querySelector(".popup__close"),o=e=>{"Escape"===e.key&&(n.classList.add("hidden"),document.removeEventListener("keydown",o))};r.addEventListener("click",(e=>{0===e.button&&(n.classList.add("hidden"),document.removeEventListener("keydown",o))})),document.addEventListener("keydown",o),e.map.insertBefore(n,e.mapFilters),e.filtersFieldsets.forEach((e=>{e.addEventListener("input",(()=>{n.classList.add("hidden")}))}))};return{renderPins:r=>{const o=document.createDocumentFragment();for(let i=0;i<Math.min(r.length,5);i+=1){const s=window.pin.createPin(e.pinTemplate,r[i]),a=e=>{0===e.button&&(t.clearCards(),n(r[i]),s.classList.add("map__pin--active"))};s.addEventListener("click",a),o.appendChild(s)}e.pinsList.appendChild(o)},renderCards:n}}},window.pinMovement={getPinMovementHandlers:(e,t)=>{let n={left:null,top:null};const r=t.pinWidth,o=t.pinHeight,i=e.map.offsetWidth;let s={x:null,y:null};const a=t=>{var a;t.preventDefault(),((e,t)=>{t.style.left=Math.max(0-r/2,Math.min(e.clientX-n.left,i-r/2))+"px",t.style.top=Math.max(130-o,Math.min(e.clientY-n.top,630-o))+"px"})(t,e.mainPin),a=e.mainPin,s.x=Math.round(a.offsetLeft+r/2),s.y=Math.round(a.offsetTop+o),e.addressInput.value=`${s.x}, ${s.y}`},u=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",u)};return{onMainPinClick:t=>{t.preventDefault(),0===t.button&&(n.left=t.clientX-e.mainPin.offsetLeft,n.top=t.clientY-e.mainPin.offsetTop,document.addEventListener("mousemove",a),document.addEventListener("mouseup",u))}}}},(()=>{const e=document.querySelector("#capacity"),t=document.querySelector("#room_number"),n=document.querySelector(".map__filters-container"),r=document.querySelector(".map"),o=document.querySelector("#card").content.querySelector(".map__card"),i=document.querySelector("#success").content.querySelector(".success"),s=document.querySelector("#error").content.querySelector(".error"),a=document.querySelector(".ad-form__reset"),u=document.querySelector(".ad-form__submit"),c=document.querySelector("#pin").content.querySelector(".map__pin"),d=document.querySelector(".map__pins"),l=document.querySelector("#housing-type"),p=document.querySelector("#housing-price"),m=document.querySelector("#housing-rooms"),f=document.querySelector("#housing-guests"),v=document.querySelector("#housing-features").querySelectorAll("input"),g=document.querySelector(".map__pin--main"),y=document.querySelector(".ad-form"),h=y.querySelectorAll("fieldset"),w=document.querySelector(".map__filters"),S=w.querySelectorAll("select, input"),L=document.querySelector("#address"),b=document.querySelector("#title"),E=document.querySelector("#type"),k=document.querySelector("#price"),I=document.querySelector("#timein"),_=document.querySelector("#timeout"),P=document.querySelector("#avatar"),q=document.querySelector("#images"),C=document.querySelector(".ad-form-header__preview img"),A=document.querySelector(".ad-form__photo"),x={mainPin:g,map:r,form:y,formFieldsets:h,filtersFieldsets:S,addressInput:L,pinTemplate:c,pinsList:d,cardTemplate:o,mapFilters:n,guestsInput:e,roomsInput:t,titleInput:b,housingTypeInput:E,priceInput:k,checkInInput:I,checkOutInput:_,housingTypeFilter:l,priceFilter:p,roomsNumberFilter:m,guestsNumberFilter:f,featuresInputs:v},F=[b,k,e];let M=[];const T=()=>{const e=d.querySelectorAll(".map__pin");for(let t=1;t<e.length;t+=1)e[t].remove()},H={clearPins:T,clearCards:()=>{document.querySelectorAll(".map .map__card").forEach((e=>{e.remove()})),d.querySelectorAll(".map__pin").forEach((e=>{e.classList.remove("map__pin--active")}))}},{renderPins:$}=window.map.getRenderingHandlers(x,H),N=window.filter.getFilterHandlers(x),V=()=>{T();const e=N(M);$(e)},D=e=>({onPopupEscPress:t=>{"Escape"===t.key&&(e.remove(),document.removeEventListener("keydown",D(e).onPopupEscPress),document.removeEventListener("click",D(e).onPopupClick))},onPopupClick:t=>{0===t.button&&(e.remove(),document.removeEventListener("click",D(e).onPopupClick),document.removeEventListener("keydown",D(e).onPopupEscPress))}}),W=()=>{y.reset(),w.reset(),j.setInactivePageMode();const e=i.cloneNode(!0);document.querySelector("main").appendChild(e),document.addEventListener("keydown",D(e).onPopupEscPress),document.addEventListener("click",D(e).onPopupClick)},O=()=>{const e=s.cloneNode(!0);document.querySelector("main").appendChild(e);const t=document.querySelector(".error__button");document.addEventListener("keydown",D(e).onPopupEscPress),document.addEventListener("click",D(e).onPopupClick),t.addEventListener("click",D(e).onPopupClick)},j=window.activation.getPageActivationHandlers(x,H,(e=>{M=e,V(),window.activation.activateFilters(x)}),(e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)})),R={pinWidth:j.pinWidth,pinHeight:j.pinHeightActive},G=window.pinMovement.getPinMovementHandlers(x,R).onMainPinClick;g.addEventListener("mousedown",G);const{validateGuestsNumber:X,setTitleConstraints:z,setHousingTypeConstraints:Y,setPriceConstraints:B,setCheckInConstraints:U,setCheckOutConstraints:J,setImageConstraints:K}=window.form.getValidityCheckHandlers(x);document.addEventListener("DOMContentLoaded",X),l.addEventListener("input",V),w.addEventListener("input",window.debounce(V)),e.addEventListener("input",X),t.addEventListener("input",X),E.addEventListener("input",Y),I.addEventListener("input",U),_.addEventListener("input",J),z(),B(),K(P),K(q),window.imagePreview.getImagePreview(P,C);const Q=document.createElement("img");Q.alt="Фотография жилья",Q.style.width="100%",q.addEventListener("change",(()=>{A.appendChild(Q)})),window.imagePreview.getImagePreview(q,Q),j.setInactivePageMode(),y.addEventListener("submit",(e=>{window.backend.uploadForm(new FormData(y),W,O),e.preventDefault()})),u.addEventListener("click",(()=>{F.forEach((e=>{e.style=e.checkValidity()?"":"box-shadow: 0 0 2px 2px red;"}))})),F.forEach((e=>{e.addEventListener("input",(()=>{e.style=e.checkValidity()?"":"box-shadow: 0 0 2px 2px red"}))})),a.addEventListener("click",(e=>{0===e.button&&(e.preventDefault(),y.reset(),w.reset(),j.setInactivePageMode())})),window.main={pageActivation:j}})()})();